/*!
 * Start Bootstrap - PhotoMap_Admin v1.0.0 (https://github.com/RunaticMoon/PhotoMap_Admin#readme)
 * Copyright 2013-2020 RunaticMoon
 * Licensed under ISC (https://github.com/BlackrockDigital/photomap_admin_page/blob/master/LICENSE)
 */

Kakao.init("7600a0cf289a958df5021746c9222d59"),AWS.config.region="ap-northeast-2",AWS.config.credentials=new AWS.CognitoIdentityCredentials({IdentityPoolId:"ap-northeast-2:181ba321-7a7e-486d-9f43-3ac178405757",RoleArn:"arn:aws:iam::383760702031:role/Cognito_photoMapAdminCognitoUnauth_Role"});var ddb=new AWS.DynamoDB,athena=new AWS.Athena,date=new Date;function partition(e,t,o){return o?"year="+e+" and month="+t+" and day="+o:t?"year="+e+" and month="+t:e?"year="+e:"year="+date.getUTCFullYear().toString()+" and month="+(date.getUTCMonth()+1).toString()+" and day="+date.getUTCDate().toString()}var me,tableName="dev-photoMapTable",users=[];function createLoginButton(){Kakao.Auth.createLoginButton({container:"#kakao-login-btn",success:function(e){console.log("Login success",JSON.stringify(e)),Kakao.API.request({url:"/v2/user/me",success:function(e){"true"==e.properties.admin?window.location.replace("/"):alert("관리자페이지에 접근할 권한이 없습니다."),console.log("user info success",JSON.stringify(e))},fail:function(e){alert("로그인이 실패했습니다."),console.log("user info error",JSON.stringify(e))}})},fail:function(e){alert("로그인이 실패했습니다."),console.log("Login error",JSON.stringify(e))}})}function getCardNumber(){console.log("getCardNumber() called");ddb.query({TableName:"queryTable",ExpressionAttributeValues:{":name":{S:"cardNumber"}},KeyConditionExpression:"queryName = :name"},function(e,t){e?console.log("Error",e):(console.log(t.Items[0].id.S),getStatus(t.Items[0].id.S,setCardNumber))})}function getCardNumber_Athena(){console.log("getCardNumber_Athena() called");var e={QueryExecutionContext:{Database:"photomap_dev_athena"},QueryString:"SELECT 'user' AS name, COUNT(uid) AS count FROM users WHERE "+partition()+" UNION SELECT 'map', COUNT(mid) FROM maps WHERE "+partition()+" UNION SELECT 'story', COUNT(sid) FROM stories WHERE "+partition()+" UNION SELECT 'log', COUNT(lid) FROM logs WHERE "+partition(),ResultConfiguration:{OutputLocation:"s3://aws-glue-photomap-dev/result"}};console.log(e.QueryString),athena.startQueryExecution(e,function(e,t){e?console.log(e,e.stack):(console.log(t),getStatus(t.QueryExecutionId,setCardNumber))})}function setCardNumber(e){var t=e.ResultSet.Rows;console.log(e),console.log(t);for(var o=1;o<t.length;o++)$("#"+get(t[o],0)+"Number").text(get(t[o],1))}function get(e,t,o){return o?e.Data[t][o]:t?e.Data[t].VarCharValue:e.Data[0].VarCharValue}function getStatus(a,n){console.log("getStatus() called");var e={QueryExecutionId:a};athena.getQueryExecution(e,function(e,t){if(e)console.log(e,e.stack);else{console.log(t);var o=t.QueryExecution.Status.State;switch(console.log(o),o){case"QUEUED":case"RUNNING":setTimeout(getStatus,1e3,a,n);break;case"SUCCEEDED":getResult(a,n)}}})}function getResult(e,o){console.log("getResult() called");var t={QueryExecutionId:e};athena.getQueryResults(t,function(e,t){e?console.log(e,e.stack):(console.log(t),console.log(t.ResultSet.Rows),o&&(console.log("callback called"),o(t)))})}function getUserInfo(){console.log("getUserInfo() called");var e={TableName:tableName,IndexName:"GSI",ExpressionAttributeValues:{":info":{S:"INFO"},":user":{S:"USER"}},KeyConditionExpression:"SK = :info and types = :user"};ddb.query(e,function(e,t){e?console.log("Error",e):(users=t.Items,$("#userNumber").text(users.length))})}function getNotice(){console.log("getNotice() called");ddb.scan({TableName:"noticeTable"},function(e,t){if(e)console.log("Error",e);else{console.log(t.Items);var a=$("#noticeTable").DataTable({data:t.Items,columns:[{data:"id.S"},{data:"title.S"},{data:"context.S"},{data:"createdAt.N"},{data:"updatedAt.N"},{data:null}],columnDefs:[{targets:-1,data:null,defaultContent:'<button class="text-danger">X</button>'}]}).order([3,"desc"]).draw();$("#noticeTable tbody").on("click","button",function(){var o=a.row($(this).parents("tr")),e={TableName:"noticeTable",Key:{id:{S:o.data().id.S}}};ddb.deleteItem(e,function(e,t){e?console.log("Error",e):(o.remove(),o.draw())})})}})}function addNotice(){console.log("addNotice() called");var e=$("#title").val(),t=$("#context").val(),o=Date.now().toString(),a={TableName:"noticeTable",Item:{id:{S:uuid()},title:{S:e},context:{S:t},createdAt:{N:o},updatedAt:{N:o}}};$("#title").val(""),$("#context").val(""),ddb.putItem(a,function(e,t){e?console.log("Error",e):(console.log(t),$("#noticeTable").DataTable().row.add(a.Item).order([3,"desc"]).draw())})}function logout(){Kakao.Auth.logout(),window.location.replace("/login.html")}function uuid4(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}function uuid(){var e=uuid4().split("-");return e[2]+e[1]+e[0]+e[3]+e[4]}$(function(){Kakao.Auth.getStatusInfo(function(e){console.log(e),"connected"==e.status?"true"!=e.user.properties.admin?(alert("관리자페이지에 접근할 권한이 없습니다."),Kakao.Auth.logout(),window.location.replace("/login.html")):(console.log("success Login"),me=e.user,$("#userDropdown > span").text(me.kakao_account.profile.nickname),$("#userDropdown > img").attr("src",me.kakao_account.profile.thumbnail_image_url)):(alert("로그인이 필요합니다."),window.location.replace("/login.html"))})});